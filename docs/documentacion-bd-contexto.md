# üìö Documentaci√≥n de BD para Contexto IA Completo

## üéØ **¬øPor qu√© Documentar la BD?**

### **‚ùå Sin Contexto de Negocio:**
```
IA ve: "services" tabla con "equipment_id" + "issue_description"
IA piensa: "Tabla gen√©rica de servicios, relevancia media"
```

### **‚úÖ Con Contexto Completo:**
```
IA entiende: "services = √ìrdenes de servicio t√©cnico de equipos industriales
- equipment_id ‚Üí Equipos de panader√≠a/cocina (hornos, laminadoras, etc.)
- issue_description ‚Üí Problemas reportados por clientes
- resolution ‚Üí Pasos de reparaci√≥n ejecutados por t√©cnicos
- parts_used ‚Üí Repuestos utilizados en reparaci√≥n
RELACI√ìN: services.equipment_id ‚Üí equipments.id (marca, modelo, tipo)
VALOR IA: CR√çTICO para predicci√≥n de fallas y sugerencia de repuestos"
```

## üèóÔ∏è **Estrategia de Documentaci√≥n Completa**

### **Nivel 1: Auto-Documentaci√≥n Inteligente**
- **An√°lisis de nombres**: IA infiere prop√≥sito desde nombres de tablas/columnas
- **Detecci√≥n de patrones**: Identifica relaciones y tipos de datos
- **An√°lisis de contenido**: Muestrea datos para entender contexto

### **Nivel 2: Contexto de Negocio Manual**
- **Prop√≥sito de cada tabla**: ¬øPara qu√© se usa en el negocio?
- **Relaciones sem√°nticas**: ¬øC√≥mo se conectan conceptualmente?
- **Importancia relativa**: ¬øQu√© tan cr√≠tica es para el KB t√©cnico?

### **Nivel 3: Metadatos Enriquecidos**
- **Diccionario de datos**: Definici√≥n precisa de cada campo
- **Reglas de negocio**: Filtros, validaciones, casos especiales
- **Ejemplos de uso**: Casos reales de c√≥mo se usa la data

## üîç **Implementaci√≥n: Auto-Documentador + Manual**

### **1. Extractor de Contexto Autom√°tico**

```python
class BusinessContextExtractor:
    def __init__(self):
        self.mysql = MySQLClient()
        self.llm = LLMClient(agent="context_analyzer")
    
    def extract_business_context(self) -> Dict[str, Any]:
        """Extrae contexto de negocio autom√°ticamente desde la BD"""
        
        context = {
            "database_overview": self._analyze_database_purpose(),
            "table_analysis": {},
            "relationship_map": self._build_relationship_map(),
            "business_patterns": self._detect_business_patterns()
        }
        
        # Analizar cada tabla con contexto
        schema = self.mysql.introspect_schema()
        
        for table_name, table_meta in schema["tables"].items():
            table_context = self._analyze_table_context(table_name, table_meta)
            context["table_analysis"][table_name] = table_context
            
        return context
    
    def _analyze_database_purpose(self) -> Dict:
        """IA infiere el prop√≥sito general de la BD"""
        
        # Obtener lista de todas las tablas
        schema = self.mysql.introspect_schema()
        table_names = list(schema["tables"].keys())
        
        prompt = f"""
        Analiza estos nombres de tablas y determina el prop√≥sito del negocio:
        
        TABLAS: {', '.join(table_names)}
        
        Bas√°ndote en los nombres, infiere:
        1. ¬øQu√© tipo de negocio es? (ej: servicios t√©cnicos, e-commerce, etc.)
        2. ¬øCu√°les son las entidades principales del dominio?
        3. ¬øQu√© procesos de negocio maneja el sistema?
        4. ¬øCu√°l es el flujo principal de datos?
        
        RESPONDE EN JSON:
        {{
          "business_type": "Servicios t√©cnicos de equipos industriales",
          "main_entities": ["equipments", "services", "customers", "technicians"],
          "business_processes": ["service_requests", "diagnostics", "repairs", "maintenance"],
          "data_flow": "Customer reports issue ‚Üí Service created ‚Üí Technician assigned ‚Üí Work performed ‚Üí Resolution documented",
          "industry_context": "Reparaci√≥n y mantenimiento de equipos de panader√≠a/cocina industrial"
        }}
        """
        
        response = self.llm.chat_completion([{"role": "user", "content": prompt}])
        return self._parse_json_response(response)
    
    def _analyze_table_context(self, table_name: str, table_meta: Dict) -> Dict:
        """Analiza contexto espec√≠fico de cada tabla"""
        
        # Obtener muestra de datos reales
        sample_data = self._get_table_sample(table_name, limit=5)
        
        # An√°lisis de columnas
        columns = table_meta.get("columns", [])
        column_analysis = self._analyze_column_semantics(columns, sample_data)
        
        # Inferir prop√≥sito con IA
        purpose_analysis = self._infer_table_purpose(table_name, columns, sample_data)
        
        return {
            "business_purpose": purpose_analysis.get("purpose", ""),
            "data_type": purpose_analysis.get("data_type", ""),
            "critical_for_ai": purpose_analysis.get("ai_relevance", 0),
            "column_semantics": column_analysis,
            "sample_data": sample_data[:2],  # Solo 2 ejemplos por privacidad
            "relationships": self._analyze_table_relationships(table_name, table_meta),
            "business_rules": self._detect_business_rules(table_name, sample_data)
        }
    
    def _infer_table_purpose(self, table_name: str, columns: List, sample_data: List) -> Dict:
        """IA infiere prop√≥sito espec√≠fico de la tabla"""
        
        column_names = [c["name"] for c in columns]
        sample_preview = json.dumps(sample_data[:2], ensure_ascii=False, indent=2) if sample_data else "Sin datos"
        
        prompt = f"""
        Analiza esta tabla en el contexto de un sistema de servicios t√©cnicos:
        
        TABLA: {table_name}
        COLUMNAS: {', '.join(column_names)}
        MUESTRA DE DATOS:
        {sample_preview}
        
        Determina:
        1. PROP√ìSITO DE NEGOCIO: ¬øPara qu√© se usa esta tabla?
        2. TIPO DE DATOS: transaccional, maestra, logs, configuraci√≥n, etc.
        3. RELEVANCIA PARA IA (0-10): ¬øQu√© tan √∫til para predicci√≥n t√©cnica?
        4. ENTIDADES T√âCNICAS: ¬øContiene info de equipos, fallas, reparaciones?
        5. VALOR PARA KB: ¬øQu√© informaci√≥n aportar√≠a al Knowledge Base?
        
        CONTEXTO: Sistema de servicios t√©cnicos para equipos industriales de panader√≠a/cocina
        
        RESPONDE EN JSON:
        {{
          "purpose": "Registra √≥rdenes de servicio t√©cnico con detalles de problemas y resoluciones",
          "data_type": "transaccional",
          "ai_relevance": 9,
          "technical_entities": ["equipment_failures", "repair_procedures", "parts_usage"],
          "kb_value": "Cr√≠tico: contiene casos reales de fallas y sus resoluciones para entrenar IA predictiva",
          "business_process": "service_management",
          "key_insights": "Cada registro representa un caso completo de diagn√≥stico y reparaci√≥n"
        }}
        """
        
        response = self.llm.chat_completion([{"role": "user", "content": prompt}])
        return self._parse_json_response(response)
```

### **2. Documentaci√≥n Manual Complementaria**

```python
# configs/bd_business_context.json
{
  "database_metadata": {
    "business_domain": "Servicios t√©cnicos de equipos industriales",
    "industry": "Reparaci√≥n y mantenimiento de equipos de panader√≠a/cocina",
    "data_classification": "Operacional y t√©cnico",
    "update_frequency": "Tiempo real durante servicios"
  },
  
  "table_documentation": {
    "services": {
      "business_purpose": "√ìrdenes de trabajo para servicios t√©cnicos",
      "data_lifecycle": "Creado ‚Üí En progreso ‚Üí Completado/Cancelado",
      "critical_fields": {
        "equipment_id": "Referencia al equipo atendido (FK a equipments)",
        "issue_description": "Problema reportado por cliente - CR√çTICO para IA",
        "resolution": "Pasos realizados por t√©cnico - CR√çTICO para KB",
        "parts_used": "Lista de repuestos utilizados - CR√çTICO para predicci√≥n",
        "technician_id": "T√©cnico asignado - relevante para contexto",
        "status": "Estado actual del servicio"
      },
      "business_rules": {
        "status_flow": "pending ‚Üí in_progress ‚Üí completed/cancelled",
        "required_completion": "resolution y parts_used obligatorios al completar",
        "data_retention": "Hist√≥rico completo para an√°lisis de tendencias"
      },
      "ai_usage": {
        "prediction_input": ["equipment_id", "issue_description", "equipment_brand"],
        "training_data": ["issue_description", "resolution", "parts_used"],
        "metadata_source": ["technician_id", "service_date", "priority"]
      }
    },
    
    "equipments": {
      "business_purpose": "Cat√°logo maestro de equipos industriales",
      "critical_fields": {
        "brand": "Marca del equipo - CR√çTICO para filtros KB",
        "model": "Modelo espec√≠fico - CR√çTICO para predicci√≥n",
        "equipment_type": "Categor√≠a (horno, laminadora, etc.) - CR√çTICO para taxonom√≠a",
        "installation_date": "Fecha instalaci√≥n - relevante para patrones de falla",
        "customer_id": "Cliente propietario - contexto del entorno"
      },
      "ai_usage": {
        "entity_extraction": ["brand", "model", "equipment_type"],
        "failure_patterns": ["installation_date", "equipment_type"],
        "context_enrichment": ["customer_location", "usage_intensity"]
      }
    }
  },
  
  "relationship_semantics": {
    "services_equipments": {
      "type": "one_to_many",
      "business_meaning": "Un equipo puede tener m√∫ltiples servicios a lo largo del tiempo",
      "ai_relevance": "CR√çTICO - permite an√°lisis hist√≥rico de fallas por equipo",
      "join_strategy": "INNER JOIN para servicios activos, LEFT JOIN para an√°lisis completo"
    },
    
    "services_customers": {
      "type": "many_to_one", 
      "business_meaning": "M√∫ltiples servicios pueden ser del mismo cliente",
      "ai_relevance": "MEDIO - contexto del entorno operativo",
      "pattern": "Clientes industriales con m√∫ltiples equipos"
    }
  },
  
  "extraction_priorities": {
    "high_priority": {
      "tables": ["services", "equipments", "activity_services"],
      "reason": "Contienen informaci√≥n t√©cnica directamente relevante para IA"
    },
    "medium_priority": {
      "tables": ["service_logs", "technicians", "customers"],
      "reason": "Proveen contexto complementario importante"
    },
    "low_priority": {
      "tables": ["user_sessions", "audit_logs"],
      "reason": "Datos operacionales sin valor t√©cnico para KB"
    }
  }
}
```

### **3. Generador de Contexto Enriquecido**

```python
class ContextEnrichedAnalyzer(DatabaseSchemaAnalyzer):
    def __init__(self):
        super().__init__()
        self.context_extractor = BusinessContextExtractor()
        self.manual_context = self._load_manual_context()
    
    def analyze_with_full_context(self) -> Dict[str, Any]:
        """An√°lisis completo con contexto autom√°tico + manual"""
        
        # 1. Extraer contexto autom√°tico
        auto_context = self.context_extractor.extract_business_context()
        
        # 2. Combinar con contexto manual
        enriched_context = self._merge_contexts(auto_context, self.manual_context)
        
        # 3. An√°lisis IA con contexto completo
        table_evaluations = {}
        
        for table_name, table_meta in enriched_context["table_analysis"].items():
            # Evaluaci√≥n IA con contexto rico
            evaluation = self._evaluate_table_with_context(
                table_name, 
                table_meta,
                enriched_context["database_overview"],
                enriched_context["relationship_map"]
            )
            table_evaluations[table_name] = evaluation
            
        return {
            "context": enriched_context,
            "evaluations": table_evaluations,
            "recommendations": self._generate_context_aware_recommendations(table_evaluations)
        }
    
    def _evaluate_table_with_context(self, table_name: str, table_context: Dict, 
                                   db_overview: Dict, relationships: Dict) -> Dict:
        """Evaluaci√≥n IA con contexto completo de negocio"""
        
        prompt = f"""
        Eval√∫a esta tabla con CONTEXTO COMPLETO de negocio:
        
        === CONTEXTO DE NEGOCIO ===
        Tipo de Negocio: {db_overview.get('business_type', 'N/A')}
        Industria: {db_overview.get('industry_context', 'N/A')}
        Proceso Principal: {db_overview.get('data_flow', 'N/A')}
        
        === TABLA A EVALUAR ===
        Nombre: {table_name}
        Prop√≥sito de Negocio: {table_context.get('business_purpose', 'N/A')}
        Tipo de Datos: {table_context.get('data_type', 'N/A')}
        Entidades T√©cnicas: {table_context.get('technical_entities', [])}
        Valor para KB: {table_context.get('kb_value', 'N/A')}
        
        === RELACIONES ===
        {json.dumps(table_context.get('relationships', {}), indent=2)}
        
        === MUESTRA DE DATOS ===
        {json.dumps(table_context.get('sample_data', []), ensure_ascii=False, indent=2)}
        
        Con este CONTEXTO COMPLETO, eval√∫a:
        
        1. RELEVANCIA T√âCNICA (0-10): ¬øQu√© tan importante para diagn√≥stico de equipos?
        2. VALOR PREDICTIVO (0-10): ¬ø√ötil para predecir fallas futuras?
        3. CALIDAD NARRATIVA (0-10): ¬øDatos ricos para generar contenido t√©cnico?
        4. PRIORIDAD ETL: CR√çTICA/ALTA/MEDIA/BAJA
        5. ESTRATEGIA EXTRACCI√ìN: 
           - full_table: Toda la tabla
           - filtered: Con filtros espec√≠ficos  
           - joined: Necesita JOIN con otras tablas
           - enriched: Requiere enriquecimiento con contexto
        6. JOIN RECOMENDADOS: ¬øCon qu√© otras tablas deber√≠a combinarse?
        7. TRANSFORMACI√ìN IA: ¬øC√≥mo convertir en narrativa t√©cnica √≥ptima?
        
        RESPONDE EN JSON con an√°lisis detallado y espec√≠fico.
        """
        
        response = self.llm.chat_completion([{"role": "user", "content": prompt}])
        return self._parse_evaluation_response(response)
```

## üìä **Dashboard de Contexto Documentado**

### **Vista de Contexto por Tabla:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          üìö CONTEXTO DE BD DOCUMENTADO                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Tabla: services                                                                 ‚îÇ
‚îÇ üéØ Prop√≥sito: √ìrdenes de servicio t√©cnico con diagn√≥sticos y resoluciones      ‚îÇ
‚îÇ üìä Tipo: Transaccional cr√≠tico                                                 ‚îÇ
‚îÇ ü§ñ IA Score: 9/10 (CR√çTICO para predicci√≥n)                                    ‚îÇ
‚îÇ üîó Relaciones: equipments (marca/modelo), customers (contexto)                 ‚îÇ
‚îÇ üí° Valor KB: Casos reales de falla + resoluci√≥n = entrenamiento IA             ‚îÇ
‚îÇ ‚öôÔ∏è Estrategia: JOIN con equipments + transformaci√≥n narrativa rica             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Tabla: equipments                                                               ‚îÇ
‚îÇ üéØ Prop√≥sito: Cat√°logo maestro de equipos industriales                         ‚îÇ
‚îÇ üìä Tipo: Datos maestros                                                        ‚îÇ
‚îÇ ü§ñ IA Score: 8/10 (CR√çTICO para taxonom√≠a y filtros)                          ‚îÇ
‚îÇ üè∑Ô∏è Entidades: brands, models, categories (auto-aprendizaje taxonom√≠a)          ‚îÇ
‚îÇ ‚öôÔ∏è Estrategia: Enriquecimiento como metadata de servicios                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ **Beneficios del Contexto Completo**

### **üéØ Precisi√≥n de Evaluaci√≥n:**
- **Contexto de negocio** ‚Üí Evaluaciones m√°s acertadas
- **Relaciones sem√°nticas** ‚Üí JOINs m√°s inteligentes  
- **Reglas de negocio** ‚Üí Filtros m√°s efectivos

### **ü§ñ IA M√°s Inteligente:**
- **Transformaciones contextuales** ‚Üí Narrativa t√©cnica rica
- **Metadata sem√°ntico** ‚Üí B√∫squedas m√°s precisas
- **Taxonom√≠a autom√°tica** ‚Üí Entidades m√°s relevantes

### **‚ö° ETL Optimizado:**
- **Estrategias espec√≠ficas** por tipo de tabla
- **JOINs pre-planificados** con contexto
- **Priorizaci√≥n inteligente** basada en valor real

## üöÄ **Plan de Implementaci√≥n**

### **Fase 1: Auto-Documentaci√≥n (1-2 d√≠as)**
1. Implementar `BusinessContextExtractor`
2. Generar an√°lisis autom√°tico de tu BD
3. Crear documentaci√≥n base

### **Fase 2: Enriquecimiento Manual (1 d√≠a)**
4. Revisar y completar contexto autom√°tico
5. A√±adir reglas de negocio espec√≠ficas
6. Documentar relaciones cr√≠ticas

### **Fase 3: An√°lisis Contextual (1 d√≠a)**
7. Integrar contexto en evaluaci√≥n IA
8. Generar configuraciones optimizadas
9. Testing con datos reales

**¬øQuieres que implemente el `BusinessContextExtractor` para empezar a documentar autom√°ticamente tu BD?** üìöü§ñ

