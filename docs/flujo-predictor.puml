@startuml Flujo Predictor de Fallas

skinparam backgroundColor #FFFFFF
skinparam handwritten false
skinparam defaultFontName Arial
skinparam defaultFontSize 11

' Colores personalizados
skinparam activity {
  BackgroundColor<<input>> #E1F5FF
  BorderColor<<input>> #01579B
  BackgroundColor<<process>> #FFF3E0
  BorderColor<<process>> #E65100
  BackgroundColor<<llm>> #F3E5F5
  BorderColor<<llm>> #4A148C
  BackgroundColor<<search>> #E8F5E9
  BorderColor<<search>> #1B5E20
  BackgroundColor<<output>> #C8E6C9
  BorderColor<<output>> #2E7D32
}

start

:ğŸ‘¤ **Usuario**
Por quÃ© service 25?;
<<input>>

:ğŸ“¥ **API /predict-fallas**
Detecta: modelo + cÃ³digo error;
<<process>>

note right
  modelo: "iCombi Classic"
  cÃ³digo: "25"
end note

:ğŸ” **BÃšSQUEDA HÃBRIDA**
====
â€¢ SemÃ¡ntica 40%: embeddings
â€¢ Keywords 60%: "service", "25"
â€¢ Boost 1.5x: docs iCombi Classic
====
âœ 18 documentos candidatos;
<<search>>

note right: â±ï¸ 1-2 segundos

:ğŸ¤– **LLM RE-RANKER**
====
Analiza CADA documento:
â€¢ Â¿Responde a la query?
â€¢ Â¿QuÃ© tan relevante? (0-100)
â€¢ Â¿Por quÃ© es relevante?
====
âœ Top 10 ordenados por LLM;
<<llm>>

note right: â±ï¸ 5-8 segundos

:ğŸ“ **CONSTRUCCIÃ“N CONTEXTO**
====
â€¢ Expande cada doc a 2000+ chars
â€¢ Total: ~15,000 caracteres
====;
<<process>>

note right: â±ï¸ 200 ms

:ğŸ¤– **GENERACIÃ“N LLM**
====
GPT-4o-mini genera:
â€¢ Fallas probables
â€¢ Repuestos necesarios
â€¢ Pasos de reparaciÃ³n
â€¢ Referencias citadas;
<<llm>>

note right: â±ï¸ 2-3 segundos

:ğŸ“š **ENRIQUECIMIENTO**
====
Agregar a cada documento:
â€¢ Relevancia LLM: 95%
â€¢ ExplicaciÃ³n del LLM
â€¢ URL navegable: pdf#page=28
â€¢ Metadata completa;
<<process>>

note right: â±ï¸ 100 ms

:âœ… **RESPUESTA JSON**
====
â€¢ DiagnÃ³stico detallado
â€¢ 10 docs ordenados
â€¢ Links a pÃ¡ginas PDFs
â€¢ Signals de calidad;
<<output>>

stop

legend right
  |<#E1F5FF> Input/Output |
  |<#FFF3E0> Procesamiento |
  |<#F3E5F5> LLM |
  |<#E8F5E9> BÃºsqueda |
  |<#C8E6C9> Respuesta |
  
  **Tiempo Total: 8-14 segundos**
  
  **Componentes Clave:**
  â€¢ services/kb/demo_kb.py
  â€¢ services/orch/llm_reranker.py
  â€¢ services/orch/rag.py
  â€¢ app/main.py
endlegend

@enduml
