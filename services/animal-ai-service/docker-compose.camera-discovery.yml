version: "3.9"

# Docker Compose para Camera Discovery Service
# Servicio centralizado para auto-descubrimiento y gestión de cámaras

services:
  # ==================== CAMERA DISCOVERY SERVICE ====================
  camera-discovery:
    build:
      context: ./discovery-service
      dockerfile: Dockerfile
    container_name: camera-discovery-service
    restart: unless-stopped
    ports:
      - "${DISCOVERY_PORT:-8090}:8090"
    environment:
      # Configuración del servicio
      - DISCOVERY_SERVICE_PORT=8090
      - DISCOVERY_SERVICE_NAME=camera-discovery
      - DISCOVERY_LOG_LEVEL=info
      - DISCOVERY_DEBUG_MODE=false
      
      # Base de datos
      - DISCOVERY_DB_HOST=discovery-db
      - DISCOVERY_DB_PORT=5432
      - DISCOVERY_DB_NAME=camera_discovery
      - DISCOVERY_DB_USER=discovery
      - DISCOVERY_DB_PASSWORD=${DISCOVERY_DB_PASSWORD:-discovery_password}
      
      # Docker para crear instancias Animal-AI
      - DOCKER_HOST=unix:///var/run/docker.sock
      - ANIMAL_AI_IMAGE=fixeatai/animal-ai:latest
      - ANIMAL_AI_NETWORK=animal-ai-network
      
      # Knowledge Base central
      - KB_URL=${KB_URL:-http://kb-service:7070/tools/kb_ingest}
      - KB_SEARCH_URL=${KB_SEARCH_URL:-http://kb-service:7070/tools/kb_search}
      
      # Load Balancer
      - NGINX_CONFIG_PATH=/etc/nginx/conf.d
      - NGINX_RELOAD_COMMAND=nginx -s reload
      
    volumes:
      # Docker socket para crear contenedores
      - /var/run/docker.sock:/var/run/docker.sock
      # Configuración de Nginx
      - nginx-config:/etc/nginx/conf.d
      # Datos persistentes
      - discovery-data:/app/data
      - discovery-logs:/app/logs
      
    networks:
      - discovery-network
      - animal-ai-network
      
    depends_on:
      - discovery-db
      - discovery-redis
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== BASE DE DATOS PARA DISCOVERY ====================
  discovery-db:
    image: postgres:15-alpine
    container_name: discovery-db
    restart: unless-stopped
    ports:
      - "${DISCOVERY_DB_PORT:-5433}:5432"
    environment:
      - POSTGRES_DB=camera_discovery
      - POSTGRES_USER=discovery
      - POSTGRES_PASSWORD=${DISCOVERY_DB_PASSWORD:-discovery_password}
    volumes:
      - discovery-db-data:/var/lib/postgresql/data
      - ./discovery-service/sql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - discovery-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U discovery"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== REDIS PARA CACHE ====================
  discovery-redis:
    image: redis:7-alpine
    container_name: discovery-redis
    restart: unless-stopped
    ports:
      - "${DISCOVERY_REDIS_PORT:-6380}:6379"
    volumes:
      - discovery-redis-data:/data
    networks:
      - discovery-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== NGINX LOAD BALANCER ====================
  nginx-lb:
    image: nginx:alpine
    container_name: nginx-load-balancer
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - nginx-config:/etc/nginx/conf.d
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    networks:
      - animal-ai-network
    depends_on:
      - camera-discovery
    command: >
      sh -c "
        # Crear configuración inicial
        echo 'upstream animal_ai_backend {
          server camera-discovery:8090;
        }
        
        server {
          listen 80;
          server_name _;
          
          location / {
            proxy_pass http://animal_ai_backend;
            proxy_set_header Host $$host;
            proxy_set_header X-Real-IP $$remote_addr;
            proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $$scheme;
          }
          
          location /ws/ {
            proxy_pass http://animal_ai_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $$http_upgrade;
            proxy_set_header Connection \"upgrade\";
            proxy_set_header Host $$host;
          }
        }' > /etc/nginx/conf.d/default.conf &&
        nginx -g 'daemon off;'
      "

  # ==================== DASHBOARD WEB ====================
  camera-dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: camera-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-3000}:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:${DISCOVERY_PORT:-8090}
      - REACT_APP_WS_URL=ws://localhost:${DISCOVERY_PORT:-8090}
    volumes:
      - dashboard-build:/app/build
    networks:
      - discovery-network
    depends_on:
      - camera-discovery

  # ==================== PROMETHEUS PARA MÉTRICAS ====================
  discovery-prometheus:
    image: prom/prometheus:latest
    container_name: discovery-prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9091}:9090"
    volumes:
      - ./monitoring/prometheus-discovery.yml:/etc/prometheus/prometheus.yml:ro
      - discovery-prometheus-data:/prometheus
    networks:
      - discovery-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'

  # ==================== GRAFANA PARA VISUALIZACIÓN ====================
  discovery-grafana:
    image: grafana/grafana:latest
    container_name: discovery-grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-worldmap-panel,grafana-piechart-panel
    volumes:
      - discovery-grafana-data:/var/lib/grafana
      - ./monitoring/grafana/discovery-dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - discovery-network
    depends_on:
      - discovery-prometheus

  # ==================== WORKER PARA TAREAS PESADAS ====================
  discovery-worker:
    build:
      context: ./discovery-service
      dockerfile: Dockerfile
    container_name: discovery-worker
    restart: unless-stopped
    command: ["celery", "-A", "app.tasks", "worker", "--loglevel=info"]
    environment:
      # Mismas variables que el servicio principal
      - WORKER_MODE=true
      - DISCOVERY_DB_HOST=discovery-db
      - DISCOVERY_DB_PASSWORD=${DISCOVERY_DB_PASSWORD:-discovery_password}
      - REDIS_URL=redis://discovery-redis:6379/0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - discovery-data:/app/data
      - discovery-logs:/app/logs
    networks:
      - discovery-network
      - animal-ai-network
    depends_on:
      - discovery-db
      - discovery-redis

# ==================== VOLÚMENES PERSISTENTES ====================
volumes:
  discovery-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DISCOVERY_DATA_PATH:-./data/discovery}
      
  discovery-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DISCOVERY_LOGS_PATH:-./data/logs}
      
  discovery-db-data:
    driver: local
    
  discovery-redis-data:
    driver: local
    
  discovery-prometheus-data:
    driver: local
    
  discovery-grafana-data:
    driver: local
    
  nginx-config:
    driver: local
    
  nginx-logs:
    driver: local
    
  dashboard-build:
    driver: local

# ==================== REDES ====================
networks:
  discovery-network:
    driver: bridge
    name: camera-discovery-network
    ipam:
      config:
        - subnet: 172.21.0.0/16
        
  animal-ai-network:
    external: true
    name: animal-ai-network


