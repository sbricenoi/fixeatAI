version: "3.9"

services:
  # ==================== ANIMAL-AI SERVICE ====================
  animal-ai-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: animal-ai-service
    restart: unless-stopped
    ports:
      - "${ANIMAL_SERVICE_PORT:-8080}:8080"
      - "${ANIMAL_METRICS_PORT:-8081}:8081"
    environment:
      # Servicio
      - ANIMAL_SERVICE_PORT=8080
      - ANIMAL_SERVICE_NAME=${ANIMAL_SERVICE_NAME:-animal-ai-production}
      - ANIMAL_LOG_LEVEL=${ANIMAL_LOG_LEVEL:-info}
      - ANIMAL_DEBUG_MODE=${ANIMAL_DEBUG_MODE:-false}
      
      # Video
      - ANIMAL_VIDEO_SOURCE=${ANIMAL_VIDEO_SOURCE}
      - ANIMAL_VIDEO_BACKUP_SOURCE=${ANIMAL_VIDEO_BACKUP_SOURCE}
      - ANIMAL_VIDEO_RESOLUTION=${ANIMAL_VIDEO_RESOLUTION:-1920x1080}
      - ANIMAL_VIDEO_FPS=${ANIMAL_VIDEO_FPS:-30}
      - ANIMAL_VIDEO_BUFFER_SIZE=${ANIMAL_VIDEO_BUFFER_SIZE:-100}
      
      # Almacenamiento
      - ANIMAL_STORAGE_PATH=/app/videos
      - ANIMAL_STORAGE_RETENTION_DAYS=${ANIMAL_STORAGE_RETENTION_DAYS:-30}
      - ANIMAL_STORAGE_MAX_SIZE_GB=${ANIMAL_STORAGE_MAX_SIZE_GB:-500}
      
      # LLM
      - ANIMAL_LLM_PROVIDER=${ANIMAL_LLM_PROVIDER:-openai}
      - ANIMAL_LLM_API_KEY=${ANIMAL_LLM_API_KEY}
      - ANIMAL_LLM_MODEL=${ANIMAL_LLM_MODEL:-gpt-4o}
      - ANIMAL_LLM_TEMPERATURE=${ANIMAL_LLM_TEMPERATURE:-0.1}
      - ANIMAL_LLM_MAX_TOKENS=${ANIMAL_LLM_MAX_TOKENS:-1000}
      
      # Computer Vision
      - ANIMAL_YOLO_MODEL=${ANIMAL_YOLO_MODEL:-yolov8n.pt}
      - ANIMAL_TRACKING_MODEL=${ANIMAL_TRACKING_MODEL:-deepsort}
      - ANIMAL_POSE_MODEL=${ANIMAL_POSE_MODEL:-mediapipe}
      - ANIMAL_CONFIDENCE_THRESHOLD=${ANIMAL_CONFIDENCE_THRESHOLD:-0.7}
      
      # Knowledge Base
      - ANIMAL_KB_URL=${ANIMAL_KB_URL}
      - ANIMAL_KB_SEARCH_URL=${ANIMAL_KB_SEARCH_URL}
      - ANIMAL_KB_AUTH_TOKEN=${ANIMAL_KB_AUTH_TOKEN}
      - ANIMAL_KB_TIMEOUT=${ANIMAL_KB_TIMEOUT:-30}
      - ANIMAL_KB_SOURCE_TYPE=${ANIMAL_KB_SOURCE_TYPE:-animal_behavior}
      - ANIMAL_KB_QUALITY_THRESHOLD=${ANIMAL_KB_QUALITY_THRESHOLD:-0.8}
      
      # Análisis
      - ANIMAL_ANALYSIS_ENABLED=${ANIMAL_ANALYSIS_ENABLED:-true}
      - ANIMAL_ANALYSIS_INTERVAL_SECONDS=${ANIMAL_ANALYSIS_INTERVAL_SECONDS:-1}
      - ANIMAL_MOVEMENT_SENSITIVITY=${ANIMAL_MOVEMENT_SENSITIVITY:-medium}
      - ANIMAL_INDIVIDUAL_TRACKING=${ANIMAL_INDIVIDUAL_TRACKING:-true}
      - ANIMAL_BEHAVIOR_LEARNING=${ANIMAL_BEHAVIOR_LEARNING:-true}
      - ANIMAL_MIN_MOVEMENT_DURATION=${ANIMAL_MIN_MOVEMENT_DURATION:-2}
      - ANIMAL_MAX_ANIMALS_PER_FRAME=${ANIMAL_MAX_ANIMALS_PER_FRAME:-10}
      - ANIMAL_TRACKING_CONFIDENCE=${ANIMAL_TRACKING_CONFIDENCE:-0.8}
      
      # Monitoreo
      - ANIMAL_LOG_FILE=/app/logs/animal-ai.log
      - ANIMAL_LOG_ROTATION=${ANIMAL_LOG_ROTATION:-daily}
      - ANIMAL_LOG_RETENTION_DAYS=${ANIMAL_LOG_RETENTION_DAYS:-30}
      - ANIMAL_METRICS_ENABLED=${ANIMAL_METRICS_ENABLED:-true}
      - ANIMAL_METRICS_PORT=8081
      - ANIMAL_PROMETHEUS_ENDPOINT=/metrics
      - ANIMAL_ALERT_WEBHOOK=${ANIMAL_ALERT_WEBHOOK}
      - ANIMAL_ALERT_EMAIL=${ANIMAL_ALERT_EMAIL}
      - ANIMAL_ALERT_ON_UNUSUAL_BEHAVIOR=${ANIMAL_ALERT_ON_UNUSUAL_BEHAVIOR:-true}
      - ANIMAL_ALERT_ON_SYSTEM_ERROR=${ANIMAL_ALERT_ON_SYSTEM_ERROR:-true}
      
      # Seguridad
      - ANIMAL_API_KEY=${ANIMAL_API_KEY}
      - ANIMAL_CORS_ORIGINS=${ANIMAL_CORS_ORIGINS:-http://localhost:3000}
      - ANIMAL_ANONYMIZE_DATA=${ANIMAL_ANONYMIZE_DATA:-false}
      - ANIMAL_ENCRYPT_VIDEOS=${ANIMAL_ENCRYPT_VIDEOS:-true}
      - ANIMAL_ENCRYPTION_KEY=${ANIMAL_ENCRYPTION_KEY}
      
    volumes:
      # Almacenamiento persistente
      - animal-videos:/app/videos
      - animal-models:/app/models
      - animal-logs:/app/logs
      - animal-data:/app/data
      - animal-configs:/app/configs
      
      # Configuración (opcional)
      - ./configs:/app/configs:ro
      
    networks:
      - animal-ai-network
      
    depends_on:
      - animal-redis
      - animal-db
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== REDIS PARA CACHE Y TAREAS ====================
  animal-redis:
    image: redis:7-alpine
    container_name: animal-redis
    restart: unless-stopped
    ports:
      - "${ANIMAL_REDIS_PORT:-6379}:6379"
    volumes:
      - animal-redis-data:/data
    networks:
      - animal-ai-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== BASE DE DATOS LOCAL ====================
  animal-db:
    image: postgres:15-alpine
    container_name: animal-db
    restart: unless-stopped
    ports:
      - "${ANIMAL_DB_PORT:-5432}:5432"
    environment:
      - POSTGRES_DB=${ANIMAL_DB_NAME:-animal_ai}
      - POSTGRES_USER=${ANIMAL_DB_USER:-animalai}
      - POSTGRES_PASSWORD=${ANIMAL_DB_PASSWORD:-animalai_password}
    volumes:
      - animal-db-data:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - animal-ai-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${ANIMAL_DB_USER:-animalai}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== WORKER PARA TAREAS PESADAS ====================
  animal-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: animal-worker
    restart: unless-stopped
    command: ["celery", "-A", "core.tasks", "worker", "--loglevel=info"]
    environment:
      # Mismas variables que el servicio principal
      - ANIMAL_SERVICE_NAME=animal-worker
      - ANIMAL_LLM_API_KEY=${ANIMAL_LLM_API_KEY}
      - ANIMAL_KB_URL=${ANIMAL_KB_URL}
      - REDIS_URL=redis://animal-redis:6379/0
    volumes:
      - animal-videos:/app/videos
      - animal-models:/app/models
      - animal-logs:/app/logs
      - animal-data:/app/data
    networks:
      - animal-ai-network
    depends_on:
      - animal-redis
      - animal-db

  # ==================== NGINX PARA PROXY Y LOAD BALANCING ====================
  animal-nginx:
    image: nginx:alpine
    container_name: animal-nginx
    restart: unless-stopped
    ports:
      - "${ANIMAL_NGINX_PORT:-80}:80"
      - "${ANIMAL_NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - animal-logs:/var/log/nginx
    networks:
      - animal-ai-network
    depends_on:
      - animal-ai-service

  # ==================== PROMETHEUS PARA MÉTRICAS ====================
  animal-prometheus:
    image: prom/prometheus:latest
    container_name: animal-prometheus
    restart: unless-stopped
    ports:
      - "${ANIMAL_PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - animal-prometheus-data:/prometheus
    networks:
      - animal-ai-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'

  # ==================== GRAFANA PARA VISUALIZACIÓN ====================
  animal-grafana:
    image: grafana/grafana:latest
    container_name: animal-grafana
    restart: unless-stopped
    ports:
      - "${ANIMAL_GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${ANIMAL_GRAFANA_PASSWORD:-admin}
    volumes:
      - animal-grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - animal-ai-network
    depends_on:
      - animal-prometheus

# ==================== VOLÚMENES PERSISTENTES ====================
volumes:
  animal-videos:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ANIMAL_VIDEOS_PATH:-./data/videos}
      
  animal-models:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ANIMAL_MODELS_PATH:-./data/models}
      
  animal-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ANIMAL_LOGS_PATH:-./data/logs}
      
  animal-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ANIMAL_DATA_PATH:-./data/app}
      
  animal-configs:
    driver: local
    
  animal-redis-data:
    driver: local
    
  animal-db-data:
    driver: local
    
  animal-prometheus-data:
    driver: local
    
  animal-grafana-data:
    driver: local

# ==================== RED INTERNA ====================
networks:
  animal-ai-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16


